<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø§Ø®ØªÙ…Ø§Ù† - Ù†Ø³Ø®Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazir', 'Tahoma', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
            flex-wrap: wrap;
        }

        .info-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            flex: 1;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .building-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            flex: 1;
            min-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            z-index: 9999;
            transition: all 0.3s;
        }

        .status-bar.online {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .status-bar.offline {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .status-bar.connecting {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }

        h1, h2 {
            color: #764ba2;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: 'Vazir', 'Tahoma', sans-serif;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #764ba2;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.4);
        }

        .btn-clear {
            background: #f44336;
            color: white;
        }

        .btn-clear:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-queue {
            background: #FF9800;
            color: white;
        }

        .btn-queue:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .btn-export {
            background: #4CAF50;
            color: white;
            margin-top: 10px;
            width: 100%;
        }

        .btn-export:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .building {
            width: 100%;
            max-width: 950px;
            margin: 0 auto;
        }

        .floor {
            background: linear-gradient(to bottom, #f5f5f5 0%, #e0e0e0 100%);
            border: 3px solid white;
            margin-bottom: 3px;
            min-height: 80px;
            display: flex;
            align-items: center;
            position: relative;
            border-radius: 5px;
        }

        .floor-number {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 10px;
            background: #764ba2;
            color: white;
            font-weight: bold;
            border-radius: 3px 0 0 3px;
            min-width: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .units {
            display: flex;
            flex: 1;
            gap: 5px;
            padding: 10px;
        }

        .unit {
            flex: 1;
            min-height: 60px;
            background: white;
            border: 2px solid #764ba2;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .unit:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }

        .unit.occupied {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .unit.selected {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border-color: #b71c1c;
        }

        .unit.has-queue {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
        }

        .unit-label {
            font-weight: bold;
            font-size: 13px;
        }

        .queue-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .unit:hover .tooltip {
            opacity: 1;
        }

        .history {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            background: white;
            margin-bottom: 10px;
            border-radius: 5px;
            border-right: 4px solid #764ba2;
        }

        .history-item strong {
            color: #764ba2;
        }

        .queue-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 8px;
            border: 2px solid #FF9800;
        }

        .queue-section h3 {
            color: #F57C00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .queue-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .queue-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 4px solid #FF9800;
        }

        .queue-item-info {
            flex: 1;
        }

        .queue-item-number {
            background: #FF9800;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 10px;
        }

        .queue-item-actions {
            display: flex;
            gap: 5px;
        }

        .btn-queue-remove {
            background: #f44336;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-queue-remove:hover {
            background: #d32f2f;
        }

        .empty-queue {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="statusBar" class="status-bar connecting">
        ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...
    </div>

    <div class="container" style="margin-top: 60px;">
        <div class="info-panel">
            <h2>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø­Ø¯</h2>
            
            <div class="form-group">
                <label>ÙˆØ§Ø­Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:</label>
                <input type="text" id="selectedUnit" readonly>
            </div>

            <div class="form-group">
                <label>Ù†Ø§Ù… Ø³Ø§Ú©Ù†:</label>
                <input type="text" id="residentName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ">
            </div>

            <div class="form-group">
                <label>ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯:</label>
                <input type="text" id="moveInDate" placeholder="Ù…Ø«Ø§Ù„: 1403/09/10">
            </div>

            <div class="form-group">
                <label>ØªØ§Ø±ÛŒØ® Ø®Ø±ÙˆØ¬ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                <input type="text" id="moveOutDate" placeholder="Ù…Ø«Ø§Ù„: 1404/01/15">
            </div>

            <div class="form-group">
                <label>ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
                <textarea id="description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ ÙˆØ§Ø­Ø¯ ÛŒØ§ Ø³Ø§Ú©Ù†..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn-save" onclick="saveResident()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn-queue" onclick="addToQueue()">ğŸ“‹ Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø±Ø²Ø±Ùˆ</button>
            </div>

            <div class="btn-group">
                <button class="btn-clear" onclick="clearCurrentResident()">ğŸ—‘ï¸ Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù†</button>
            </div>

            <button class="btn-export" onclick="exportToExcel()">ğŸ“Š Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´ Excel</button>

            <div class="queue-section" id="queueSection">
                <h3>ğŸ“‹ Ù„ÛŒØ³Øª Ø±Ø²Ø±Ùˆ ÙˆØ§Ø­Ø¯</h3>
                <div class="queue-list" id="queueList"></div>
            </div>

            <div class="history" id="history">
                <h3 style="color: #764ba2; margin-bottom: 10px;">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙˆØ§Ø­Ø¯</h3>
                <p style="color: #666;">Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
            </div>
        </div>

        <div class="building-container">
            <h1>ğŸ¢ Ø³Ø§Ø®ØªÙ…Ø§Ù† Ø¨Ø±Ø¬ Ø³ÙÛŒØ¯</h1>
            <div class="building" id="buildingFloors"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase - Ø§ÛŒÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ùˆ Ø§Ø² Firebase Console Ú©Ù¾ÛŒ Ú©Ù†
        var firebaseConfig = {
            apiKey: "AIzaSyBXQH3ewyGAYFJnjlzaV18-8TxoP-Hn0rg",
            authDomain: "borjesefid-760c4.firebaseapp.com",
            databaseURL: "https://borjesefid-760c4-default-rtdb.firebaseio.com",
            projectId: "borjesefid-760c4",
            storageBucket: "borjesefid-760c4.firebasestorage.app",
            messagingSenderId: "906769793126",
            appId: "1:906769793126:web:a16acd4316214b27b8eda7"
        };

        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();
        var residentsRef = database.ref('residents');

        var connectedRef = database.ref('.info/connected');
        connectedRef.on('value', function(snap) {
            var statusBar = document.getElementById('statusBar');
            if (snap.val() === true) {
                statusBar.className = 'status-bar online';
                statusBar.textContent = 'ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù‡ Ø³Ø±ÙˆØ± - ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
            } else {
                statusBar.className = 'status-bar offline';
                statusBar.textContent = 'ğŸ”´ Ù‚Ø·Ø¹ Ø§Ø±ØªØ¨Ø§Ø· - Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯...';
            }
        });

        var buildingData = {
            10: [{id: '10', number: '10'}],
            9: [{id: '9', number: '9'}],
            8: [{id: '8', number: '8'}],
            7: [{id: '7', number: '7'}],
            6: [{id: '6', number: '6'}],
            5: [{id: '5', number: '5'}],
            4: [{id: '4', number: '4'}],
            3: [{id: '3', number: '3'}],
            2: [
                {id: '2-south', number: 'Ø¬Ù†ÙˆØ¨ÛŒ'},
                {id: '2-north', number: 'Ø´Ù…Ø§Ù„ÛŒ'}
            ],
            1: [
                {id: '1-south', number: 'Ø¬Ù†ÙˆØ¨ÛŒ'},
                {id: '1-north', number: 'Ø´Ù…Ø§Ù„ÛŒ'}
            ]
        };

        var residents = {};
        var selectedUnitId = null;

        residentsRef.on('value', function(snapshot) {
            residents = snapshot.val() || {};
            renderBuilding();
            if (selectedUnitId) {
                showHistory(selectedUnitId);
                showQueue(selectedUnitId);
            }
        });

        function renderBuilding() {
            var container = document.getElementById('buildingFloors');
            container.innerHTML = '';

            for (var floor = 10; floor >= 1; floor--) {
                var floorDiv = document.createElement('div');
                floorDiv.className = 'floor';

                var floorNumber = document.createElement('div');
                floorNumber.className = 'floor-number';
                floorNumber.textContent = 'Ø·Ø¨Ù‚Ù‡ ' + floor;

                var unitsDiv = document.createElement('div');
                unitsDiv.className = 'units';

                buildingData[floor].forEach(function(unit) {
                    var unitDiv = document.createElement('div');
                    unitDiv.className = 'unit';
                    
                    var resident = residents[unit.id] ? residents[unit.id].current : null;
                    var queueLength = residents[unit.id] && residents[unit.id].queue ? residents[unit.id].queue.length : 0;
                    
                    if (resident && resident.name) {
                        unitDiv.classList.add('occupied');
                    }
                    
                    if (queueLength > 0 && (!resident || !resident.name)) {
                        unitDiv.classList.add('has-queue');
                    }
                    
                    if (unit.id === selectedUnitId) {
                        unitDiv.classList.add('selected');
                    }

                    if (queueLength > 0) {
                        var badge = document.createElement('div');
                        badge.className = 'queue-badge';
                        badge.textContent = queueLength;
                        unitDiv.appendChild(badge);
                    }

                    var label = document.createElement('div');
                    label.className = 'unit-label';
                    label.textContent = 'ÙˆØ§Ø­Ø¯ ' + unit.number;

                    var tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    if (resident && resident.name) {
                        var tooltipText = 'ğŸ‘¤ Ø³Ø§Ú©Ù†: ' + resident.name + '<br>';
                        tooltipText += 'ğŸ“… ÙˆØ±ÙˆØ¯: ' + resident.moveInDate + '<br>';
                        if (resident.moveOutDate) {
                            tooltipText += 'ğŸšª Ø®Ø±ÙˆØ¬: ' + resident.moveOutDate;
                        } else {
                            tooltipText += 'âœ… Ø³Ø§Ú©Ù† ÙØ¹Ù„ÛŒ';
                        }
                        if (queueLength > 0) {
                            tooltipText += '<br>ğŸ“‹ Ø±Ø²Ø±Ùˆ: ' + queueLength + ' Ù†ÙØ±';
                        }
                        tooltip.innerHTML = tooltipText;
                    } else if (queueLength > 0) {
                        tooltip.innerHTML = 'ğŸ“‹ Ù„ÛŒØ³Øª Ø±Ø²Ø±Ùˆ: ' + queueLength + ' Ù†ÙØ± Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±';
                    } else {
                        tooltip.textContent = 'ÙˆØ§Ø­Ø¯ Ø®Ø§Ù„ÛŒ';
                    }

                    unitDiv.appendChild(tooltip);
                    unitDiv.appendChild(label);

                    unitDiv.onclick = function() {
                        selectUnit(unit.id, 'Ø·Ø¨Ù‚Ù‡ ' + floor + ' - ÙˆØ§Ø­Ø¯ ' + unit.number);
                    };

                    unitsDiv.appendChild(unitDiv);
                });

                floorDiv.appendChild(floorNumber);
                floorDiv.appendChild(unitsDiv);
                container.appendChild(floorDiv);
            }
        }

        function selectUnit(unitId, unitNumber) {
            selectedUnitId = unitId;
            document.getElementById('selectedUnit').value = unitNumber;

            var resident = residents[unitId] ? residents[unitId].current : null;
            if (resident) {
                document.getElementById('residentName').value = resident.name || '';
                document.getElementById('moveInDate').value = resident.moveInDate || '';
                document.getElementById('moveOutDate').value = resident.moveOutDate || '';
                document.getElementById('description').value = resident.description || '';
            } else {
                document.getElementById('residentName').value = '';
                document.getElementById('moveInDate').value = '';
                document.getElementById('moveOutDate').value = '';
                document.getElementById('description').value = '';
            }

            showHistory(unitId);
            showQueue(unitId);
            renderBuilding();
        }

        function showQueue(unitId) {
            var queueList = document.getElementById('queueList');
            var queue = residents[unitId] && residents[unitId].queue ? residents[unitId].queue : [];

            if (queue.length === 0) {
                queueList.innerHTML = '<div class="empty-queue">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø¯Ø± Ù„ÛŒØ³Øª Ø±Ø²Ø±Ùˆ Ù†ÛŒØ³Øª</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < queue.length; i++) {
                var person = queue[i];
                html += '<div class="queue-item">';
                html += '<div class="queue-item-number">' + (i + 1) + '</div>';
                html += '<div class="queue-item-info">';
                html += '<strong>' + person.name + '</strong><br>';
                html += '<small>ğŸ“… Ø«Ø¨Øª Ø±Ø²Ø±Ùˆ: ' + person.registrationDate + '</small><br>';
                html += '<small>ğŸ“¥ ÙˆØ±ÙˆØ¯: ' + (person.moveInDate || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡') + '</small><br>';
                html += '<small>ğŸ“¤ Ø®Ø±ÙˆØ¬: ' + (person.moveOutDate || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡') + '</small>';
                if (person.description) {
                    html += '<br><small>ğŸ“ ' + person.description + '</small>';
                }
                html += '</div>';
                html += '<div class="queue-item-actions">';
                html += '<button class="btn-queue-remove" onclick="removeFromQueue(\'' + unitId + '\', ' + i + ')">Ø­Ø°Ù</button>';
                html += '</div>';
                html += '</div>';
            }
            queueList.innerHTML = html;
        }

        function addToQueue() {
            if (!selectedUnitId) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            var name = document.getElementById('residentName').value.trim();
            var moveInDate = document.getElementById('moveInDate').value.trim();
            var moveOutDate = document.getElementById('moveOutDate').value.trim();
            var description = document.getElementById('description').value.trim();

            if (!name) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø®Øµ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            var unitRef = residentsRef.child(selectedUnitId);
            unitRef.once('value', function(snapshot) {
                var unitData = snapshot.val() || { current: {}, history: [], queue: [] };
                
                if (!unitData.queue) {
                    unitData.queue = [];
                }

                unitData.queue.push({
                    name: name,
                    registrationDate: new Date().toLocaleDateString('fa-IR'),
                    moveInDate: moveInDate,
                    moveOutDate: moveOutDate,
                    description: description
                });

                unitRef.set(unitData, function(error) {
                    if (error) {
                        alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + error.message);
                    } else {
                        alert('âœ… ' + name + ' Ø¨Ù‡ Ù„ÛŒØ³Øª Ø±Ø²Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
                        document.getElementById('residentName').value = '';
                        document.getElementById('moveInDate').value = '';
                        document.getElementById('moveOutDate').value = '';
                        document.getElementById('description').value = '';
                    }
                });
            });
        }

        function removeFromQueue(unitId, index) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù†ÙØ± Ø§Ø² Ù„ÛŒØ³Øª Ø±Ø²Ø±Ùˆ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                var unitRef = residentsRef.child(unitId);
                unitRef.once('value', function(snapshot) {
                    var unitData = snapshot.val();
                    if (unitData && unitData.queue) {
                        unitData.queue.splice(index, 1);
                        unitRef.set(unitData);
                    }
                });
            }
        }

        function saveResident() {
            if (!selectedUnitId) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            var name = document.getElementById('residentName').value.trim();
            var moveInDate = document.getElementById('moveInDate').value.trim();
            var moveOutDate = document.getElementById('moveOutDate').value.trim();
            var description = document.getElementById('description').value.trim();

            if (!name || !moveInDate) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø³Ø§Ú©Ù† Ùˆ ØªØ§Ø±ÛŒØ® ÙˆØ±ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            var unitRef = residentsRef.child(selectedUnitId);
            unitRef.once('value', function(snapshot) {
                var unitData = snapshot.val() || { current: {}, history: [], queue: [] };

                if (unitData.current && unitData.current.name && unitData.current.name !== name) {
                    if (!unitData.history) {
                        unitData.history = [];
                    }
                    unitData.history.push({
                        name: unitData.current.name,
                        moveInDate: unitData.current.moveInDate,
                        moveOutDate: unitData.current.moveOutDate,
                        description: unitData.current.description
                    });
                }

                unitData.current = { 
                    name: name, 
                    moveInDate: moveInDate, 
                    moveOutDate: moveOutDate, 
                    description: description 
                };

                unitRef.set(unitData, function(error) {
                    if (error) {
                        alert('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + error.message);
                    } else {
                        alert('âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                    }
                });
            });
        }

        function clearCurrentResident() {
            if (!selectedUnitId) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ÙˆØ§Ø­Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }

            var unitRef = residentsRef.child(selectedUnitId);
            unitRef.once('value', function(snapshot) {
                var unitData = snapshot.val();
                
                if (!unitData || !unitData.current || !unitData.current.name) {
                    alert('Ø§ÛŒÙ† ÙˆØ§Ø­Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
                    return;
                }

                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø®Ø§Ù„ÛŒ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† ÙˆØ§Ø­Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                    if (!unitData.current.moveOutDate) {
                        var moveOutDate = prompt('ØªØ§Ø±ÛŒØ® Ø®Ø±ÙˆØ¬ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 1404/09/10):');
                        if (moveOutDate) {
                            unitData.current.moveOutDate = moveOutDate;
                        }
                    }

                    if (!unitData.history) {
                        unitData.history = [];
                    }

                    unitData.history.push({
                        name: unitData.current.name,
                        moveInDate: unitData.current.moveInDate,
                        moveOutDate: unitData.current.moveOutDate,
                        description: unitData.current.description
                    });

                    unitData.current = {};

                    unitRef.set(unitData, function(error) {
                        if (error) {
                            alert('âŒ Ø®Ø·Ø§: ' + error.message);
                        } else {
                            alert('âœ… ÙˆØ§Ø­Ø¯ Ø®Ø§Ù„ÛŒ Ø´Ø¯');
                            document.getElementById('residentName').value = '';
                            document.getElementById('moveInDate').value = '';
                            document.getElementById('moveOutDate').value = '';
                            document.getElementById('description').value = '';
                        }
                    });
                }
            });
        }

        function showHistory(unitId) {
            var historyDiv = document.getElementById('history');
            var history = residents[unitId] && residents[unitId].history ? residents[unitId].history : [];

            if (history.length === 0) {
                historyDiv.innerHTML = '<h3 style="color: #764ba2; margin-bottom: 10px;">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙˆØ§Ø­Ø¯</h3><p style="color: #666;">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ÙˆØ§Ø­Ø¯ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                return;
            }

            var html = '<h3 style="color: #764ba2; margin-bottom: 10px;">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙˆØ§Ø­Ø¯</h3>';
            var reversedHistory = history.slice().reverse();
            for (var i = 0; i < reversedHistory.length; i++) {
                var record = reversedHistory[i];
                html += '<div class="history-item">';
                html += '<strong>Ø³Ø§Ú©Ù† ' + (history.length - i) + ':</strong> ' + record.name + '<br>';
                html += '<strong>ÙˆØ±ÙˆØ¯:</strong> ' + record.moveInDate + '<br>';
                html += '<strong>Ø®Ø±ÙˆØ¬:</strong> ' + (record.moveOutDate || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡') + '<br>';
                if (record.description) {
                    html += '<strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ' + record.description;
                }
                html += '</div>';
            }
            historyDiv.innerHTML = html;
        }

        function exportToExcel() {
            var htmlContent = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
            htmlContent += '<head><meta charset="UTF-8"><style>';
            htmlContent += 'table { border-collapse: collapse; width: 100%; direction: rtl; }';
            htmlContent += 'th, td { border: 1px solid black; padding: 8px; text-align: right; }';
            htmlContent += 'th { background-color: #764ba2; color: white; font-weight: bold; }';
